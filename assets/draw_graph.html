<html>
    <head>
        <style>
            .node circle {
    fill: #fff;
    stroke: steelblue;
    stroke-width: 1.5px;
}
.node text {
    font: 10px sans-serif;
}


        </style>
    </head>
    <body>
        <div id="filePath" style="display:None">
            {{.FilePath}}
        </div>
        <div id="viz"></div>
        <script src="assets/drawFiles/d3.v3.min.js"></script>
        <script type="text/javascript">
            var DEFAULT_JSON_FILE_PATH = "assets/data/temp.json"

            /*
             Found this from - 
             http://stackoverflow.com/questions/38222685/visualizing-a-parse-tree-with-d3-js
             https://jsfiddle.net/scsiva1991/22vx8v18/1/
            */
      		function drawTree(d3args) {
                var width = d3args.width,
                    height = d3args.height,
                    padding = d3args.padding,
                    elementId = "#" + d3args.divId,
                    treeData = d3args.treeData

                var tree = d3.layout.tree()
                    .size([height, width - padding]);

                var diagonal = d3.svg.diagonal()
                    .projection(function (d) {
                        return [d.y, d.x];
                    });

                var svg = d3.select(elementId).append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(40,0)");

                var root = treeData,
                    nodes = tree.nodes(root),
                    links = tree.links(nodes);

                var link = svg.selectAll(".link")
                    .data(links)
                    .enter()
                    .append("g")
                    .attr("class", "link");

                link.append("path")
                    .attr("fill", "none")
                    .attr("stroke", "#ff8888")
                    .attr("stroke-width", "1.5px")
                    .attr("d", diagonal);

                link.append("text")
                    .attr("font-family", "Arial, Helvetica, sans-serif")
                    .attr("fill", "Black")
                    .style("font", "normal 12px Arial")
                    .attr("transform", function(d) {
                        return "translate(" +
                            ((d.source.y + d.target.y)/2) + "," + 
                            ((d.source.x + d.target.x)/2) + ")";
                    })   
                    .attr("dy", ".35em")
                    .attr("text-anchor", "middle")
                    .text(function(d) {
                        console.log(d.target.rule);
                         return d.target.rule;
                    });

                var node = svg.selectAll(".node")
                    .data(nodes)
                    .enter()
                    .append("g")
                    .attr("class", "node")
                    .attr("transform", function (d) {
                        return "translate(" + d.y + "," + d.x + ")";
                    });

                node.append("circle")
                    .attr("r", 4.5);

                node.append("text")
                    .attr("dx", function (d) {
                        return d.children ? -8 : 8;
                    })
                    .attr("dy", 3)
                    .style("text-anchor", function (d) {
                        return d.children ? "end" : "start";
                    })
                    .text(function (d) {
                        return d.name;
                    });
  		        /*
  				d3.select("#"+o.divID).select("svg").remove()

  				var viz = d3.select("#"+o.divID)
  					.append("svg")
  					.attr("width", o.width)
  					.attr("height", o.height)  

  				var vis = viz.append("g")
  					.attr("id","treeg")
  					.attr("transform", "translate("+ o.padding +","+ o.padding +")") 

  				var tree = d3.layout.tree()
  					.size([o.width - (2 * o.padding), o.height - (2 * o.padding)]);

  				var diagonal = d3.svg.diagonal()
  					.projection(function(d) { return [d.x, d.y]; });

  				var nodes = tree.nodes(o.treeData);

  				var link = vis.selectAll("pathlink")
  					.data(tree.links(nodes)).enter()
  					.append("path")
  					.attr("class", "link")
  					.attr("d", diagonal)

  				var node = vis.selectAll("g.node")
  					.data(nodes).enter()
  					.append("g")
  					.attr("transform", function(d) { console.log(d);return "translate(" + d.x + "," + d.y + ")"; })

  				node.append("circle")
  					.attr("r", 10)
  					.style("fill", function(d) { return (d.children) ? "#E14B3B" : "#1C8B98" });

  				node.append("svg:text")
  					.attr("dx", function(d) { return d.children ? 0 : 0; })
  					.attr("dy", function(d) { return d.children ? 5 : 5; })
  					.attr("text-anchor", function(d) { return d.children ? "middle" : "middle"; })
  					.style("fill", "white").text(function(d) { return d.name; })

                link.append("text")
                    .attr("font-family", "Arial, Helvetica, sans-serif")
                    .attr("fill", "Black")
                    .style("font", "normal 12px Arial")
                    .attr("transform", function(d) {
                        return "translate(" +
                            ((d.source.y + d.target.y)/2) + "," + 
                            ((d.source.x + d.target.x)/2) + ")";
                    })   
                    .attr("dy", ".35em")
                    .attr("text-anchor", "middle")
                    .text(function(d) {
                        console.log(d.target.rule);
                        return d.target.rule;
                    });
                    */
      		}

            function drawGraphFromFile(filePath){
                if(typeof(filePath) === "undefined" || filePath.trim() === ""){
                    filePath = DEFAULT_JSON_FILE_PATH;
                }
                console.log("File path - " + filePath);
                makeReq(DEFAULT_JSON_FILE_PATH)
            }

            function makeReq(url) {
                // Don't bother with making this too neat for now.
                // Just basically get it working
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                  if (xhttp.readyState == 4 && xhttp.status == 200) {
                    var respTest = xhttp.responseText;
                    var treeContents = JSON.parse(respTest)
                    drawTree({
                        divId: 'viz', 
                        width: 400, 
                        height: 300, 
                        padding: 100, 
                        treeData : treeContents
                    });
                  }
              };
              xhttp.open("GET", url, true);
              xhttp.send();
            }

            (function (){
                /*
                   Fetching the json file specified int he filePath id
                */
                var fileElem = document.getElementById("filePath");
                if(!fileElem || typeof(fileElem) === "undefined"){
                    console.log("Choosing default");
                    filePath = DEFAULT_JSON_FILE_PATH;
                }else{
                    filePath = fileElem.innerText.trim();
                }
                drawGraphFromFile(filePath);
            })()
        </script>
    </body>
</html>
